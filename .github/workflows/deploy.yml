name: React App CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. ë¹Œë“œ ë‹¨ê³„
  build:
    name: ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘ (Clean Install)..."
          npm ci

      - name: ë¹Œë“œ ì‹¤í–‰
        run: |
          echo "ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ ì¤‘..."
          npm run build

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í™•ì¸
        run: |
          echo "âœ… ë¹Œë“œ ì™„ë£Œ!"
          echo "ğŸ“ dist ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la dist/
          echo "ğŸ“Š ë¹Œë“œ í¬ê¸°:"
          du -sh dist/

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: dist/
          retention-days: 1

  # 2. í…ŒìŠ¤íŠ¸ ë‹¨ê³„
  test:
    name: í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¦°íŠ¸ ê²€ì‚¬
        run: |
          echo "ğŸ” ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ ì¤‘..."
          npm run lint

      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          npm test -- --watchAll=false

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: ./dist

      - name: ë¹Œë“œ íŒŒì¼ ê²€ì¦
        run: |
          echo "ğŸ” ë¹Œë“œ íŒŒì¼ ê²€ì¦ ì¤‘..."
          test -f dist/index.html || (echo "âŒ index.htmlì´ ì—†ìŠµë‹ˆë‹¤!" && exit 1)
          echo "âœ… ë¹Œë“œ íŒŒì¼ ê²€ì¦ ì™„ë£Œ"

  # 3. ë°°í¬ ë‹¨ê³„
  deploy:
    name: ë°°í¬
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: dist
      - name: SCP files to Nginx Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.NGINX_PRIVATE_IP }} # ëª©ì ì§€: Nginx ë‚´ë¶€ IP
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}       # Nginx ì„œë²„ ì ‘ì†ìš© í‚¤
          proxy_host: ${{ secrets.BASTION_IP }} # ê²½ìœ ì§€: Bastion ê³µì¸ IP
          proxy_username: ubuntu
          proxy_key: ${{ secrets.EC2_SSH_KEY }} # Bastion ì ‘ì†ìš© í‚¤
          source: "dist/*" 
          target: "/home/ubuntu/react_temp"
          strip_components: 1

      # 2. SSHë¥¼ í†µí•´ Nginx ì„œë²„ì—ì„œ íŒŒì¼ ì´ë™ ì‘ì—… ìˆ˜í–‰
      - name: Finalize Deployment on Nginx Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.NGINX_PRIVATE_IP }} # ëª©ì ì§€: Nginx ë‚´ë¶€ IP
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          proxy_host: ${{ secrets.BASTION_IP }} # ê²½ìœ ì§€: Bastion ê³µì¸ IP
          proxy_username: ubuntu
          proxy_key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ë³´
            sudo mkdir -p /var/www/react
            sudo chown -R ubuntu:ubuntu /var/www/react
            
            # 2. ê¸°ì¡´ íŒŒì¼ êµì²´
            rm -rf /var/www/react/*
            cp -r /home/ubuntu/react_temp/* /var/www/react/
            
            # 3. ì„ì‹œ íŒŒì¼ ì‚­ì œ ë° Nginx ë°˜ì˜
            rm -rf /home/ubuntu/react_temp
            sudo systemctl reload nginx
            echo "Deployment Successful!"

  # 4. ì•Œë¦¼ ë‹¨ê³„ (ì„ íƒì‚¬í•­)
  notify:
    name: ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build, test, deploy]
    if: always()

    steps:
      - name: ì‘ì—… ìƒíƒœ í™•ì¸
        id: status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=ë°°í¬ ì„±ê³µ" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
            echo "status=skipped" >> $GITHUB_OUTPUT
            echo "emoji=â­ï¸" >> $GITHUB_OUTPUT
            echo "message=ë°°í¬ ê±´ë„ˆëœ€ (PR ë˜ëŠ” ë‹¤ë¥¸ ë¸Œëœì¹˜)" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          fi

      - name: Slack ì•Œë¦¼
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} *React App ë°°í¬ ìƒíƒœ*",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.status == 'success' && 'good' || steps.status.outputs.status == 'skipped' && 'warning' || 'danger' }}",
                  "fields": [
                    {
                      "title": "ìƒíƒœ",
                      "value": "${{ steps.status.outputs.message }}",
                      "short": true
                    },
                    {
                      "title": "ë¸Œëœì¹˜",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "ì»¤ë°‹",
                      "value": "`${{ github.sha }}`",
                      "short": false
                    },
                    {
                      "title": "ì‹¤í–‰ì",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "ì›Œí¬í”Œë¡œìš°",
                      "value": "${{ github.workflow }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
